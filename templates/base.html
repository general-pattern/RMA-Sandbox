<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{% block title %}RMA System{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='edit-mode.css') }}">
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="header-left">
        <a href="{{ url_for('index') }}" class="logo-link">
          <div class="app-title">General Pattern</div>
          <div class="app-subtitle">RMA Database</div>
        </a>
      </div>
      
      <nav class="app-nav">
        <a href="{{ url_for('index') }}" class="nav-link">Dashboard</a>
        
        <a href="{{ url_for('metrics') }}" class="nav-link">Metrics</a>

        <!-- RMAs Dropdown -->
        <div class="nav-dropdown">
          <button class="nav-dropdown-btn">RMAs <span class="dropdown-arrow">▼</span></button>
          <div class="nav-dropdown-content">
            <a href="{{ url_for('new_rma') }}">✚ New RMA</a>
            <a href="{{ url_for('list_rmas') }}">● All RMAs</a>
            <!-- Status filters -->
            <a href="{{ url_for('list_rmas', status='Draft') }}">– Draft</a>
            <a href="{{ url_for('list_rmas', status='Acknowledged') }}">– Acknowledged</a>
            <a href="{{ url_for('list_rmas', status='In Progress') }}">– In Progress</a>
            <a href="{{ url_for('list_rmas', status='Rejected') }}">– Rejected</a>
            <a href="{{ url_for('list_rmas', status='Closed') }}">– Closed</a>
          </div>
        </div>
        
        
        <!-- Credits Dropdown -->
        <div class="nav-dropdown">
          <button class="nav-dropdown-btn">Credits <span class="dropdown-arrow">▼</span></button>
          <div class="nav-dropdown-content">
            <a href="{{ url_for('credit_dashboard') }}">● Credit Dashboard</a>
            <a href="{{ url_for('list_rmas') }}?return_type=Credit">● Credit RMAs</a>
            <a href="{{ url_for('list_rmas') }}?return_type=Credit&credit_approved=pending">● Pending Approval</a>
          </div>
        </div>
        
        <!-- Admin Dropdown - Only for admins -->
{% if current_user and current_user['role'] == 'admin' %}
<div class="nav-dropdown">
  <button class="nav-dropdown-btn">Admin <span class="dropdown-arrow">▼</span></button>
  <div class="nav-dropdown-content">
    <a href="{{ url_for('admin_users') }}">● Manage Users</a>
    <a href="{{ url_for('register') }}">● Add User</a>
    <div style="border-top: 1px solid var(--gray-200); margin: 5px 0;"></div>
    <a href="{{ url_for('list_customers') }}">● Customers</a>
  </div>
</div>
{% else %}
<!-- Regular users see direct links -->
<a href="{{ url_for('list_customers') }}" class="nav-link">Customers</a>
{% endif %}
       
        <!-- User Menu / Auth Links -->
        {% if current_user %}
        <div class="nav-dropdown user-menu">
          <button class="nav-dropdown-btn user-btn">
            <span class="user-avatar">{{ current_user['full_name'][0] }}</span>
            {{ current_user['full_name'] }}
            <span class="dropdown-arrow">▼</span>
          </button>
          <div class="nav-dropdown-content">
            <a href="{{ url_for('profile') }}">● Profile</a>
            <a href="{{ url_for('notification_preferences') }}">● Notifications</a>
            <a href="{{ url_for('logout') }}" class="logout-link">Logout</a>
          </div>
        </div>
        {% elif session.get('user_id') %}
          {# Fallback: session says logged in, but current_user is None #}
          <a href="{{ url_for('logout') }}" class="nav-link">Logout</a>
        {% else %}
          {# Not logged in at all #}
          <a href="{{ url_for('login') }}" class="nav-link">Login</a>
        {% endif %}
      </nav>
    </header>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for category, message in messages %}
            <div class="flash-message flash-{{ category }}">
              <span class="flash-text">{{ message }}</span>

              <div class="flash-actions">
                {% if session.get('last_undo') %}
                <form method="post"
                      action="{{ url_for('undo_last') }}"
                      class="flash-undo-form">
                  <!-- Unicode circular arrow icon -->
                  <button type="submit"
                          class="flash-icon-btn flash-undo-btn"
                          title="Undo last action">
                    ↺
                  </button>
                </form>
                {% endif %}

                <button class="flash-icon-btn flash-close"
                        onclick="this.parentElement.parentElement.remove()"
                        title="Dismiss">
                  ×
                </button>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <main class="app-content">
      {% block content %}{% endblock %}
    </main>
    
    <footer class="app-footer">
      <p>RMA System &copy; {{ now().year if now is defined else '2024' }}</p>
    </footer>
  </div>
</body>
</html>









