{% extends "base.html" %}
{% block content %}

<div class="page-header">
  <h2>ðŸ‘¥ Manage Users</h2>
  {% if current_user['role'] == 'admin' %}
  <a href="{{ url_for('register') }}" class="btn-primary">âž• Add User</a>
  {% endif %}
</div>

<div class="card">
  <p class="results-count">{{ users|length }} user{{ 's' if users|length != 1 else '' }}</p>
  
  {% if users %}
  <table>
    <thead>
      <tr>
        <th>Username</th>
        <th>Full Name</th>
        <th>Email</th>
        <th>Role</th>
        <th>Created</th>
        <th>Last Login</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr>
        <td><strong>{{ u['username'] }}</strong></td>
        <td>{{ u['full_name'] }}</td>
        <td>{{ u['email'] }}</td>
        <td>
          {% if u['user_id'] == current_user['user_id'] %}
            <span class="status-badge" style="background-color: #dbeafe; color: #1e40af;">
              {{ u['role']|upper }} (You)
            </span>
          {% elif u['role'] == 'admin' %}
            <span class="status-badge" style="background-color: #fecaca; color: #991b1b;">
              ADMIN
            </span>
          {% else %}
            <span class="status-badge" style="background-color: #d1fae5; color: #065f46;">
              USER
            </span>
          {% endif %}
        </td>
        <td>{{ u['created_on']|short_date }}</td>
        <td>{{ u['last_login']|short_date if u['last_login'] else '-' }}</td>
        <td>
          <div style="display: flex; gap: 8px;">
            <!-- Edit User -->
            <a href="{{ url_for('edit_user', user_id=u['user_id']) }}" 
               class="btn-secondary" 
               style="padding: 4px 8px; font-size: 12px; text-decoration: none;">
              Edit
            </a>
            
            {% if current_user['role'] == 'admin' and u['user_id'] != current_user['user_id'] %}
            <!-- Change Role (Admin only) -->
            <form method="POST" action="{{ url_for('change_user_role', user_id=u['user_id']) }}" style="display: inline;">
              <select name="role" onchange="this.form.submit()" style="padding: 4px 8px; font-size: 12px; border-radius: 4px;">
                <option value="user" {% if u['role'] == 'user' %}selected{% endif %}>User</option>
                <option value="admin" {% if u['role'] == 'admin' %}selected{% endif %}>Admin</option>
              </select>
            </form>
            
            <!-- Delete User (Admin only) -->
            <form method="POST" action="{{ url_for('delete_user', user_id=u['user_id']) }}" 
                  style="display: inline;"
                  onsubmit="return confirm('Are you sure you want to delete user {{ u['username'] }}? This cannot be undone.');">
              <button type="submit" class="btn-secondary" style="padding: 4px 8px; font-size: 12px; color: #dc2626;">
                Delete
              </button>
            </form>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="empty-state">
    <p>No users found.</p>
  </div>
  {% endif %}
</div>

{% endblock %}
